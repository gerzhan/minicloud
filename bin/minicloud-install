#!/usr/bin/env node
var path = require('path')
var fs = require('fs')
var exec = require('child_process').exec
var config = require(path.resolve(process.cwd(), 'config.json'))
var dbConfig = {
	storage: './minicloud.db',
	dialect: 'sqlite'
}
if(config){
	var database = config.database
	if(database){
		dbConfig = database
	}
}
var migrationConfig = {
	development:dbConfig,
	test:dbConfig,
	production:dbConfig
}

//save config
var configPath = path.resolve(process.cwd(), './bin/config.json') 
fs.writeFile(configPath,JSON.stringify(migrationConfig),function(error){
	//run migration
	var migrationPath = path.resolve(process.cwd(), './lib/model/migrations')
	var binPath = path.resolve(process.cwd(), './node_modules/sequelize-cli/bin/sequelize')
	binPath += ' db:migrate ' 
	binPath += ' --migrations-path='+migrationPath+' ' 
	binPath += ' --config='+configPath+' '
	exec(binPath,function (error, stdout, stderr){
		if(!error){
			console.log('\n\ndatabase initialize success!\n\n')
		}else{

		}
		console.log(stdout) 
	})
}) 